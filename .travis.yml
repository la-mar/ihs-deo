version: ~> 1.0
sudo: required
dist: xenial
language: python

python:
  - "3.7"

# run unit tests
# Build image
# smoke test
# integration test
# deploy

# stages:
#   - lint
#   - unittest
# - name: deploy
#   if: tag IS present

notifications:
  email:
    on_failure: always
    recipients:
      - brock@driftwoodenergy.com

cache:
  directories:
    - "$HOME/.cache/pip"
    - docker_images

services:
  - docker
  - mongodb
  - redis

env:
  global:
    - PYCURL_SSL_LIBRARY=openssl
    - GIT_COMMITTED_AT=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then git log -1 --pretty=format:%ct; else git log -1 --skip 1 --pretty=format:%ct; fi)
    - IMAGE_NAME: driftwood/ihs
    # - PATH=$HOME/.local/bin:$PATH
    # - PATH "/root/.poetry/bin:/opt/venv/bin:${PATH}"

before_install:
  - pip install awscli
  - pip install boto3
  - pip install poetry
  - pip install docker
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build
  # - docker load -i docker_images/images.tar || true

# before_cache:
#   - docker save -o docker_images/images.tar $(docker images -a -q)

install:
  - poetry install -v

# before_script:
# - poetry run pre-commit install-hooks
# - poetry run pre-commit run --all-files

# script:
#   - poetry run pytest --doctest-modules --cov-report term-missing --cov-report html:htmlcov --cov=src/cltkv1 src/cltkv1/ tests
# script: skip

jobs:
  include:
    # - stage: lint and unit test
    #   script: pylint ihs --exit-zero $PYLINT_ARGS
    #   script: make run-tests
    # # - stage: unit tests
    # #   script: make run-tests
    # # - stage: integration tests
    # #   script: make integration-tests
    - stage: build image
      script: COMMIT_HASH=$TRAVIS_COMMIT && make build
    - stage: smoke test
      script: make smoke-test
    - stage: deploy
      script: skip
      deploy:
        # deploy to github releases on git tag
        # - provider: releases
        #   skip_cleanup: true
        #   token: $GITHUB_TOKEN
        #   target_commitish: master
        #   name: ihs
        #   tag_name: $TRAVIS_TAG
        #   on:
        #     tags: true
        # push docker image on git tag
        # - provider: script
        #   script: make travis-deploy-docker-tags
        #   on:
        #     branch: master
        #     tags: true
        # push dev docker image
        - provider: script
          script: make travis-deploy-docker-dev
          on:
            branch: master

after_success:
  - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT
  - codecov
